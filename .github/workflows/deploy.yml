name: Deploy to EC2

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  NODE_VERSION: '18'
  EC2_HOST: ${{ secrets.EC2_HOST }}
  EC2_USER: ${{ secrets.EC2_USER }}
  EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to EC2
        env:
          PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'ENDSSH'
            # Don't exit on error for yt-dlp installation - use multiple fallback methods
            set -e
            
            # Create app directory if it doesn't exist
            sudo mkdir -p /var/www/youtube-downloader
            sudo chown -R $USER:$USER /var/www/youtube-downloader
            
            cd /var/www/youtube-downloader
            
            # Check if git repository exists
            if [ ! -d ".git" ]; then
              echo "Cloning repository for the first time..."
              # If directory is empty or doesn't exist, clone
              if [ ! "$(ls -A .)" ]; then
                git clone https://github.com/karthikeyankumbam/video-downloader.git .
              else
                git init
                git remote add origin https://github.com/karthikeyankumbam/video-downloader.git || git remote set-url origin https://github.com/karthikeyankumbam/video-downloader.git
                git fetch origin
                git checkout -b main origin/main || git checkout -b main origin/master || true
              fi
            else
              echo "Updating existing repository..."
              git fetch origin
              git reset --hard origin/main || git reset --hard origin/master
            fi
            
            # Install/update system dependencies if needed
            # Update package list
            sudo apt-get update -qq
            
            if ! command -v git &> /dev/null; then
              echo "Installing Git..."
              sudo apt-get install -y git
            fi
            
            # Install lsof for port checking
            if ! command -v lsof &> /dev/null; then
              echo "Installing lsof..."
              sudo apt-get install -y lsof
            fi
            
            if ! command -v node &> /dev/null; then
              echo "Installing Node.js..."
              curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
              sudo apt-get install -y nodejs
            fi
            
            # Install yt-dlp (handle externally-managed-environment error)
            if ! command -v yt-dlp &> /dev/null; then
              echo "Installing yt-dlp..."
              
              # Method 1: Direct binary download (no Python dependencies - most reliable)
              echo "Downloading yt-dlp binary..."
              sudo curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp -o /usr/local/bin/yt-dlp
              sudo chmod a+rx /usr/local/bin/yt-dlp
              
              # Verify installation
              if yt-dlp --version > /dev/null 2>&1; then
                echo "✅ yt-dlp installed successfully (binary)"
              else
                echo "Binary method failed, trying pipx..."
                
                # Method 2: pipx (manages its own virtual environment)
                set +e  # Don't exit on error
                sudo apt-get install -y pipx python3-venv
                export PATH="$HOME/.local/bin:$PATH"
                pipx install yt-dlp 2>/dev/null
                
                if yt-dlp --version > /dev/null 2>&1; then
                  echo "✅ yt-dlp installed successfully (pipx)"
                else
                  echo "pipx failed, trying pip with --break-system-packages..."
                  
                  # Method 3: pip with --break-system-packages flag
                  sudo apt-get install -y python3 python3-pip
                  sudo pip3 install --break-system-packages yt-dlp 2>&1
                  
                  if yt-dlp --version > /dev/null 2>&1; then
                    echo "✅ yt-dlp installed successfully (pip)"
                  else
                    echo "⚠️ WARNING: yt-dlp installation failed, but continuing deployment..."
                  fi
                fi
                set -e  # Re-enable exit on error
              fi
              
              # Final check
              if command -v yt-dlp &> /dev/null; then
                echo "✅ yt-dlp ready: $(yt-dlp --version)"
              else
                echo "❌ ERROR: yt-dlp not available - deployment may fail!"
              fi
            else
              echo "✅ yt-dlp already installed: $(yt-dlp --version)"
            fi
            
            # Install JavaScript runtime for yt-dlp (needed for YouTube extraction)
            # QuickJS is lightweight and works well
            if ! command -v quickjs &> /dev/null && ! command -v nodejs &> /dev/null; then
              echo "Installing JavaScript runtime (QuickJS) for yt-dlp..."
              sudo apt-get install -y quickjs || echo "QuickJS not available, Node.js will be used instead"
            fi
            
            if ! command -v pm2 &> /dev/null; then
              echo "Installing PM2..."
              sudo npm install -g pm2
            fi
            
            # Install/update Node.js dependencies
            # Use npm ci if package-lock.json exists, otherwise use npm install
            if [ -f "package-lock.json" ]; then
              echo "Installing dependencies with npm ci..."
              npm ci --production
            else
              echo "package-lock.json not found, using npm install..."
              npm install --production --omit=dev
            fi
            
            # Create logs directory
            mkdir -p logs
            
            # Check if port 3000 is in use and kill the process if needed
            if lsof -ti:3000 > /dev/null 2>&1; then
              echo "Port 3000 is in use. Stopping existing process..."
              sudo lsof -ti:3000 | xargs sudo kill -9 || true
              sleep 2
            fi
            
            # Stop any existing PM2 processes with the same name
            pm2 delete youtube-downloader 2>/dev/null || true
            sleep 1
            
            # Start or restart application with PM2
            if pm2 list | grep -q "youtube-downloader"; then
              echo "Restarting existing application..."
              pm2 restart youtube-downloader
            else
              echo "Starting new application..."
              pm2 start ecosystem.config.js || pm2 start server.js --name youtube-downloader
            fi
            
            # Ensure PM2 startup script is configured
            pm2 startup systemd -u $USER --hp $HOME 2>/dev/null || true
            
            # Save PM2 process list
            pm2 save
            
            echo "Deployment completed successfully!"
          ENDSSH

      - name: Verify deployment
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'ENDSSH'
            echo "Checking PM2 status..."
            pm2 status || echo "PM2 not running"
            
            echo "Waiting for application to start..."
            sleep 5
            
            echo "Checking application health..."
            curl -f http://localhost:3000/api/health || echo "Health check failed, but deployment completed"
          ENDSSH

